service: build-pelican-in-lambda

plugins:
- serverless-python-requirements
custom:
  stage: "${opt:stage, env:SLS_STAGE, 'dev'}"
  log_level: "${env:LOG_LEVEL, 'INFO'}"

  pythonRequirements:
    dockerizePip: false
  bucket_name: "chrabasz.cz"
  git_repo: https://github.com/alchrabas/blog.git


provider:
  name: aws
  runtime: python3.6
  stage: ${self:custom.stage}
  environment:
    LOG_LEVEL: ${self:custom.log_level}
  stackTags:
    x-service: build-pelican-in-lambda
    x-stack: ${self:service}-${self:provider.stage}
  region: eu-central-1
  iamRoleStatements:
  - Effect: Allow
    Action:
    - lambda:InvokeFunction
    Resource: "*"
  - Effect: Allow
    Action:
    - "s3:PutObject"
    Resource:
      Fn::Join: ['', [Fn::GetAtt: [ BlogBucket, Arn ], '/*'] ]


functions:
  async_rebuild_blog_from_git:
    handler: handlers/action.async_handler
    description: "Rebuilds pelican blog from contents stored in git"
    memorySize: 512
    timeout: 600
    environment:
      BUCKET_NAME: ${self:custom.bucket_name}
      URL_TO_GIT_REPO_HTTPS: ${self:custom.git_repo}
  rebuild_blog_from_git:
    handler: handlers/action.http_rebuild_blog
    description: "Makes async call to async_rebuild_blog_from_git lambda"
    environment:
      LAMBDA_REBUILD_ASYNC: build-pelican-in-lambda-${self:custom.stage}-async_rebuild_blog_from_git
    events:
    - http:
        path: rebuild
        method: get


resources:
  Resources:
    BlogBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.bucket_name}
